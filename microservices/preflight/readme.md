# Preflight Tornado WebSocket Server

## Overview

Preflight is a WebSocket server implemented using Python's Tornado framework and Redis. It allows multiple clients to connect via WebSockets and receives updates based on Redis HSET events. 

## Features

- **WebSocket Management**: Handles multiple WebSocket connections, sending heartbeat pings, and checking for client responsiveness.
- **Redis Subscription**: Listens for HSET events on Redis and forwards relevant data to connected WebSocket clients based on their `run_id`.
- **Asynchronous Operations**: Uses Python's asyncio and Tornado's asynchronous capabilities to handle WebSocket connections and interact with Redis in a non-blocking manner.

## Prerequisites

- Python 3.7+
- Tornado
- aioredis
- Redis Server

## Configuration

### Redis Configuration

Ensure that the following line is present and uncommented in your `redis.conf` file to enable keyspace notifications:

```conf
notify-keyspace-events Ksh

### Notes for Future Development

For Python versions 3.7+, consider replacing `asyncio.ensure_future()` with `asyncio.create_task()`
for creating asynchronous tasks, as it is more idiomatic and readable.

## Preflight Service

The `preflight` service is a Tornado WebSocket server deployed using `systemd` to ensure it is managed and kept running in the background.

### Service File Location

The `systemd` service file for the preflight service is located at:

```
/etc/systemd/system/preflight.service
```

This file contains the configuration for starting and managing the service.

### Server File Location

The main Python script for the `preflight` server is located at:

```
/workdir/weppcloud2/microservices/preflight/preflight_server.py
```

### Managing the Service with `systemctl`

To manage the `preflight` service, you can use `systemctl`, a command-line utility that allows you to interact with the systemd system and service manager. Below are some common `systemctl` commands related to managing your service.

#### Start the Service

To start the `preflight` service, use the following command:

```bash
sudo systemctl start preflight.service
```

#### Stop the Service

To stop the `preflight` service, use the following command:

```bash
sudo systemctl stop preflight.service
```

#### Check the Service Status

To check the status of the `preflight` service, which includes whether it is active, inactive, or failed, as well as log messages, use the following command:

```bash
sudo systemctl status preflight.service
```

#### Enable the Service at Boot

To ensure that the `preflight` service starts automatically at boot, use the following command:

```bash
sudo systemctl enable preflight.service
```

#### Disable the Service from Starting at Boot

If you want to prevent the service from starting automatically at boot, use the following command:

```bash
sudo systemctl disable preflight.service
```

### Logs

You can view the logs generated by the `preflight` service using `journalctl`:

```bash
sudo journalctl -u preflight.service
```

This command displays the logs for the `preflight` service, which can be useful for debugging and monitoring the service status.

### Additional Notes

Ensure that the server script and all related files have the appropriate permissions and ownership for the user specified in the service file (e.g., `www-data`). The service should be able to read, execute, and write (if necessary) to all relevant files and directories.
